python3 << 'PYEOF'
html = open("/opt/attribution/dashboard.html").read()

# Replace login box
old_login = '''<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">App<span>Track</span></div>
    <div class="login-sub">// MMP Dashboard v1.0</div>
    <div class="form-group">
      <label>API Key</label>
      <input type="password" id="login-key" placeholder="oa_..." autocomplete="off">
    </div>
    <button class="btn-primary" onclick="doLogin()">Access Dashboard</button>
    <div class="login-error" id="login-error">âŒ Invalid API Key</div>
  </div>
</div>'''

new_login = '''<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">App<span>Track</span></div>
    <div class="login-sub">// MMP Dashboard v1.0</div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="login-email" placeholder="admin@apptrack.in" autocomplete="off">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="off">
    </div>
    <button class="btn-primary" onclick="doLogin()">Login</button>
    <div class="login-error" id="login-error">âŒ Invalid email or password</div>
  </div>
</div>'''

html = html.replace(old_login, new_login)

# Replace doLogin function
old_fn = """async function doLogin() {
  const key = document.getElementById('login-key').value.trim();
  if (!key) return;

  try {
    const res = await fetch(`${API}/v1/health`, {
      headers: { 'X-API-Key': key }
    });
    if (res.ok) {
      apiKey = key;
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('sidebar-key').textContent = key.substring(0, 16) + '...';
      initDashboard();
    } else {
      // Try campaigns endpoint to verify key
      const r2 = await fetch(`${API}/v1/campaigns`, {
        headers: { 'X-API-Key': key }
      });
      if (r2.ok || r2.status === 200) {
        apiKey = key;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('sidebar-key').textContent = key.substring(0, 16) + '...';
        initDashboard();
      } else {
        document.getElementById('login-error').style.display = 'block';
      }
    }
  } catch(e) {
    // If server responds at all, accept the key
    apiKey = key;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('sidebar-key').textContent = key.substring(0, 16) + '...';
    initDashboard();
  }
}

document.getElementById('login-key').addEventListener('keypress', e => {
  if (e.key === 'Enter') doLogin();
});"""

new_fn = """let userRole = '';
let userName = '';
let jwtToken = '';

async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass  = document.getElementById('login-password').value.trim();
  if (!email || !pass) return;

  try {
    const res = await fetch(`${API}/v1/auth/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass })
    });
    const data = await res.json();
    if (!res.ok) {
      document.getElementById('login-error').style.display = 'block';
      return;
    }
    jwtToken = data.token;
    userRole = data.role;
    userName = data.name;
    apiKey   = 'oa_dqal8zWP_C3i5vWfPZ-0P2ZZeo3cde2719tBMlaLbLw'; // master key for API calls

    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('sidebar-key').textContent = userName + ' (' + userRole + ')';

    // Admin only nav items
    if (userRole === 'admin') {
      document.getElementById('nav-users').style.display = 'flex';
    }

    initDashboard();
  } catch(e) {
    document.getElementById('login-error').style.display = 'block';
  }
}

document.getElementById('login-email').addEventListener('keypress', e => {
  if (e.key === 'Enter') doLogin();
});
document.getElementById('login-password').addEventListener('keypress', e => {
  if (e.key === 'Enter') doLogin();
});"""

html = html.replace(old_fn, new_fn)

# Add Users nav item (hidden by default)
old_nav = """      <div class="nav-item" onclick="showSection('fraud')">
        <span class="icon">ğŸ›¡ï¸</span> Fraud
      </div>"""

new_nav = """      <div class="nav-item" onclick="showSection('fraud')">
        <span class="icon">ğŸ›¡ï¸</span> Fraud
      </div>
      <div class="nav-item" id="nav-users" style="display:none" onclick="showSection('users')">
        <span class="icon">ğŸ‘¥</span> Users
      </div>"""

html = html.replace(old_nav, new_nav)

# Add Users section before closing main div
old_fraud_end = """    </div>

  </div>
</div>"""

new_fraud_end = """    </div>

    <!-- USERS (Admin only) -->
    <div class="section" id="section-users">
      <div class="section-header">
        <div class="section-title">Users</div>
        <button class="btn btn-accent" onclick="openCreateUser()">+ New User</button>
      </div>
      <div class="card">
        <div id="users-table">
          <div style="padding:20px"><div class="loading"></div></div>
        </div>
      </div>
    </div>

  </div>
</div>"""

html = html.replace(old_fraud_end, new_fraud_end)

# Add Create User Modal before TOAST
old_toast = """<!-- TOAST -->
<div class="toast" id="toast"></div>"""

new_toast = """<!-- CREATE USER MODAL -->
<div class="modal-overlay" id="user-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('user-modal')">Ã—</button>
    <h3>New Customer</h3>
    <div class="form-group">
      <label>Name</label>
      <input type="text" id="u-name" placeholder="John Doe">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="u-email" placeholder="john@company.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="u-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('user-modal')">Cancel</button>
      <button class="btn btn-accent" onclick="createUser()">Create</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>"""

html = html.replace(old_toast, new_toast)

# Add users JS before closing script
old_script_end = """// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) m.classList.remove('open');
  });
});
</script>"""

new_script_end = """// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) m.classList.remove('open');
  });
});

// â”€â”€ USERS (Admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
  try {
    const data = await api('/v1/users');
    const el = document.getElementById('users-table');
    const users = data.users || [];
    if (users.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="icon">ğŸ‘¥</div>No customers yet</div>';
      return;
    }
    el.innerHTML = `
      <table>
        <thead><tr>
          <th>Name</th><th>Email</th><th>Role</th><th>Plan</th><th>Status</th><th>Actions</th>
        </tr></thead>
        <tbody>
          ${users.map(u => `
            <tr>
              <td>${u.name}</td>
              <td>${u.email}</td>
              <td><span class="badge badge-purple">${u.role}</span></td>
              <td><span class="badge ${u.plan === 'paid' ? 'badge-green' : u.plan === 'enterprise' ? 'badge-yellow' : 'badge-red'}">${u.plan}</span></td>
              <td><span class="badge ${u.is_active ? 'badge-green' : 'badge-red'}">${u.is_active ? 'ACTIVE' : 'DISABLED'}</span></td>
              <td>
                <div style="display:flex;gap:6px;flex-wrap:wrap">
                  <button class="btn btn-outline" onclick="upgradePlan('${u.id}','paid')" title="Upgrade to Paid">ğŸ’³ Paid</button>
                  <button class="btn btn-outline" onclick="upgradePlan('${u.id}','free')" title="Downgrade to Free">Free</button>
                  <button class="btn btn-danger" onclick="toggleUser('${u.id}',${!u.is_active})">${u.is_active ? 'Disable' : 'Enable'}</button>
                  <button class="btn btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  } catch(e) {
    document.getElementById('users-table').innerHTML = '<div style="padding:20px;color:var(--red)">Failed to load users</div>';
  }
}

function openCreateUser() {
  document.getElementById('user-modal').classList.add('open');
}

async function createUser() {
  const name  = document.getElementById('u-name').value.trim();
  const email = document.getElementById('u-email').value.trim();
  const pass  = document.getElementById('u-pass').value.trim();
  if (!name || !email || !pass) { showToast('Fill all fields!'); return; }
  try {
    await api('/v1/auth/register', 'POST', { name, email, password: pass });
    closeModal('user-modal');
    showToast('âœ… Customer created!');
    loadUsers();
  } catch(e) { showToast('Failed to create user'); }
}

async function upgradePlan(uid, plan) {
  await api(`/v1/users/${uid}/plan?plan=${plan}`, 'PUT');
  showToast('âœ… Plan updated!');
  loadUsers();
}

async function toggleUser(uid, status) {
  await api(`/v1/users/${uid}/status?is_active=${status}`, 'PUT');
  showToast('âœ… Status updated!');
  loadUsers();
}

async function deleteUser(uid) {
  if (!confirm('Delete this user?')) return;
  await api(`/v1/users/${uid}`, 'DELETE');
  showToast('âœ… User deleted!');
  loadUsers();
}
</script>"""

html = html.replace(old_script_end, new_script_end)

# Fix showSection to load users
old_show = """  if (name === 'campaigns') loadCampaigns();
  if (name === 'installs') loadInstalls();
  if (name === 'events') loadEvents();
  if (name === 'fraud') loadFraud();"""

new_show = """  if (name === 'campaigns') loadCampaigns();
  if (name === 'installs') loadInstalls();
  if (name === 'events') loadEvents();
  if (name === 'fraud') loadFraud();
  if (name === 'users') loadUsers();"""

html = html.replace(old_show, new_show)

with open("/opt/attribution/dashboard.html", "w") as f:
    f.write(html)

print(f"âœ… Dashboard updated! {len(html)} chars")
PYEOF
