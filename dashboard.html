<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AppTrack ‚Äî MMP Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --surface2: #1a1a24;
    --border: #2a2a3a;
    --accent: #00ff88;
    --accent2: #7c3aed;
    --accent3: #f59e0b;
    --red: #ff4444;
    --text: #e8e8f0;
    --muted: #6b6b8a;
    --font-mono: 'Space Mono', monospace;
    --font: 'Syne', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
  #login-screen {
    position: fixed; inset: 0;
    background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    z-index: 1000;
    background-image: radial-gradient(ellipse at 20% 50%, rgba(124,58,237,0.15) 0%, transparent 60%),
                      radial-gradient(ellipse at 80% 20%, rgba(0,255,136,0.08) 0%, transparent 50%);
  }

  .login-box {
    width: 400px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 48px 40px;
    position: relative;
    overflow: hidden;
  }

  .login-box::before {
    content: '';
    position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, var(--accent2), var(--accent));
  }

  .login-logo {
    font-size: 28px; font-weight: 800; letter-spacing: -1px;
    margin-bottom: 8px;
  }

  .login-logo span { color: var(--accent); }

  .login-sub {
    color: var(--muted); font-size: 13px; margin-bottom: 36px;
    font-family: var(--font-mono);
  }

  .form-group { margin-bottom: 20px; }

  .form-group label {
    display: block; font-size: 11px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase;
    color: var(--muted); margin-bottom: 8px;
    font-family: var(--font-mono);
  }

  .form-group input {
    width: 100%; padding: 12px 16px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 14px;
    font-family: var(--font-mono); outline: none;
    transition: border-color 0.2s;
  }

  .form-group input:focus { border-color: var(--accent); }

  .btn-primary {
    width: 100%; padding: 14px;
    background: var(--accent); color: #000;
    border: none; border-radius: 8px;
    font-size: 14px; font-weight: 700; font-family: var(--font);
    cursor: pointer; transition: opacity 0.2s;
    letter-spacing: 0.5px;
  }

  .btn-primary:hover { opacity: 0.9; }

  .login-error {
    color: var(--red); font-size: 12px; font-family: var(--font-mono);
    margin-top: 12px; text-align: center; display: none;
  }

  /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
  #app { display: none; }

  .sidebar {
    position: fixed; left: 0; top: 0; bottom: 0; width: 220px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    display: flex; flex-direction: column;
    z-index: 100;
  }

  .sidebar-logo {
    padding: 24px 20px;
    font-size: 20px; font-weight: 800;
    border-bottom: 1px solid var(--border);
    letter-spacing: -0.5px;
  }

  .sidebar-logo span { color: var(--accent); }

  .sidebar-nav { flex: 1; padding: 16px 12px; }

  .nav-item {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-radius: 8px;
    cursor: pointer; font-size: 14px; font-weight: 600;
    color: var(--muted); transition: all 0.15s;
    margin-bottom: 4px;
  }

  .nav-item:hover { color: var(--text); background: var(--surface2); }
  .nav-item.active { color: var(--accent); background: rgba(0,255,136,0.08); }
  .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }

  .sidebar-footer {
    padding: 16px 20px;
    border-top: 1px solid var(--border);
    font-size: 11px; font-family: var(--font-mono);
    color: var(--muted);
  }

  .status-dot {
    display: inline-block; width: 6px; height: 6px;
    border-radius: 50%; background: var(--accent);
    margin-right: 6px; animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  .main {
    margin-left: 220px;
    min-height: 100vh;
    padding: 32px;
  }

  /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
  .section { display: none; }
  .section.active { display: block; }

  .section-header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 28px;
  }

  .section-title {
    font-size: 24px; font-weight: 800; letter-spacing: -0.5px;
  }

  /* ‚îÄ‚îÄ STATS CARDS ‚îÄ‚îÄ */
  .stats-grid {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 16px; margin-bottom: 28px;
  }

  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; padding: 20px;
    position: relative; overflow: hidden;
  }

  .stat-card::after {
    content: '';
    position: absolute; bottom: 0; left: 0; right: 0; height: 2px;
  }

  .stat-card.green::after { background: var(--accent); }
  .stat-card.purple::after { background: var(--accent2); }
  .stat-card.yellow::after { background: var(--accent3); }
  .stat-card.red::after { background: var(--red); }

  .stat-label {
    font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; color: var(--muted);
    font-family: var(--font-mono); margin-bottom: 10px;
  }

  .stat-value {
    font-size: 32px; font-weight: 800; letter-spacing: -1px;
  }

  .stat-card.green .stat-value { color: var(--accent); }
  .stat-card.purple .stat-value { color: var(--accent2); }
  .stat-card.yellow .stat-value { color: var(--accent3); }
  .stat-card.red .stat-value { color: var(--red); }

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 12px; overflow: hidden; margin-bottom: 20px;
  }

  .card-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    font-size: 13px; font-weight: 700;
  }

  table { width: 100%; border-collapse: collapse; }

  th {
    padding: 12px 20px; text-align: left;
    font-size: 11px; font-weight: 700; letter-spacing: 1.2px;
    text-transform: uppercase; color: var(--muted);
    font-family: var(--font-mono);
    border-bottom: 1px solid var(--border);
  }

  td {
    padding: 14px 20px; font-size: 13px;
    border-bottom: 1px solid rgba(42,42,58,0.5);
    font-family: var(--font-mono);
  }

  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--surface2); }

  .badge {
    display: inline-block; padding: 3px 8px;
    border-radius: 4px; font-size: 11px; font-weight: 700;
    font-family: var(--font-mono);
  }

  .badge-green { background: rgba(0,255,136,0.12); color: var(--accent); }
  .badge-red { background: rgba(255,68,68,0.12); color: var(--red); }
  .badge-yellow { background: rgba(245,158,11,0.12); color: var(--accent3); }
  .badge-purple { background: rgba(124,58,237,0.12); color: #a78bfa; }

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn {
    padding: 8px 16px; border-radius: 6px; border: none;
    font-size: 13px; font-weight: 700; cursor: pointer;
    font-family: var(--font); transition: all 0.15s;
  }

  .btn-accent { background: var(--accent); color: #000; }
  .btn-accent:hover { opacity: 0.85; }
  .btn-outline {
    background: transparent; color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-outline:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: rgba(255,68,68,0.12); color: var(--red); border: 1px solid rgba(255,68,68,0.2); }
  .btn-danger:hover { background: rgba(255,68,68,0.2); }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    display: none; align-items: center; justify-content: center;
    z-index: 500;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px; width: 560px;
    max-height: 85vh; overflow-y: auto;
    position: relative;
  }

  .modal h3 {
    font-size: 18px; font-weight: 800; margin-bottom: 24px;
  }

  .modal .form-group input,
  .modal .form-group textarea,
  .modal .form-group select {
    width: 100%; padding: 10px 14px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text); font-size: 13px;
    font-family: var(--font-mono); outline: none;
    transition: border-color 0.2s;
  }

  .modal .form-group textarea { resize: vertical; min-height: 80px; }
  .modal .form-group input:focus,
  .modal .form-group textarea:focus { border-color: var(--accent); }

  .modal-footer {
    display: flex; gap: 10px; justify-content: flex-end;
    margin-top: 24px;
  }

  .close-modal {
    position: absolute; top: 16px; right: 16px;
    background: none; border: none; color: var(--muted);
    font-size: 20px; cursor: pointer;
  }

  /* ‚îÄ‚îÄ LOGS ‚îÄ‚îÄ */
  .log-container {
    background: #080810; border: 1px solid var(--border);
    border-radius: 12px; padding: 20px;
    height: 480px; overflow-y: auto;
    font-family: var(--font-mono); font-size: 12px;
    line-height: 1.8;
  }

  .log-line { display: flex; gap: 12px; padding: 2px 0; }
  .log-time { color: var(--muted); flex-shrink: 0; }
  .log-install { color: var(--accent); }
  .log-event { color: #60a5fa; }
  .log-fraud { color: var(--red); }
  .log-postback { color: var(--accent3); }
  .log-click { color: #a78bfa; }
  .log-info { color: var(--muted); }

  /* ‚îÄ‚îÄ TRACKING URL ‚îÄ‚îÄ */
  .url-box {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 16px;
    font-family: var(--font-mono); font-size: 12px;
    color: var(--accent); word-break: break-all;
    cursor: pointer; transition: border-color 0.2s;
  }

  .url-box:hover { border-color: var(--accent); }

  /* ‚îÄ‚îÄ EVENTS BUILDER ‚îÄ‚îÄ */
  .event-row {
    display: grid; grid-template-columns: 1fr 2fr auto;
    gap: 10px; margin-bottom: 10px; align-items: center;
  }

  .add-event-btn {
    color: var(--accent); background: rgba(0,255,136,0.08);
    border: 1px dashed rgba(0,255,136,0.3);
    border-radius: 6px; padding: 8px; width: 100%;
    cursor: pointer; font-size: 13px; font-family: var(--font);
    font-weight: 600; transition: all 0.15s;
  }

  .add-event-btn:hover { background: rgba(0,255,136,0.15); }

  /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
  .loading {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state {
    text-align: center; padding: 60px 20px;
    color: var(--muted); font-size: 14px;
  }

  .empty-state .icon { font-size: 40px; margin-bottom: 12px; }

  /* ‚îÄ‚îÄ COPY TOAST ‚îÄ‚îÄ */
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    background: var(--accent); color: #000;
    padding: 10px 20px; border-radius: 8px;
    font-size: 13px; font-weight: 700;
    transform: translateY(60px); opacity: 0;
    transition: all 0.3s; z-index: 999;
  }

  .toast.show { transform: translateY(0); opacity: 1; }

  .section-tabs {
    display: flex; gap: 4px; margin-bottom: 20px;
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; padding: 4px; width: fit-content;
  }

  .tab {
    padding: 7px 16px; border-radius: 6px; cursor: pointer;
    font-size: 13px; font-weight: 600; color: var(--muted);
    transition: all 0.15s;
  }

  .tab.active { background: var(--surface2); color: var(--text); }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">App<span>Track</span></div>
    <div class="login-sub">// MMP Dashboard v1.0</div>
    <div class="form-group">
      <label>API Key</label>
      <input type="password" id="login-key" placeholder="oa_..." autocomplete="off">
    </div>
    <button class="btn-primary" onclick="doLogin()">Access Dashboard</button>
    <div class="login-error" id="login-error">‚ùå Invalid API Key</div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-logo">App<span>Track</span></div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="showSection('overview')">
        <span class="icon">üìä</span> Overview
      </div>
      <div class="nav-item" onclick="showSection('campaigns')">
        <span class="icon">üéØ</span> Campaigns
      </div>
      <div class="nav-item" onclick="showSection('logs')">
        <span class="icon">‚ö°</span> Live Logs
      </div>
      <div class="nav-item" onclick="showSection('installs')">
        <span class="icon">üì≤</span> Installs
      </div>
      <div class="nav-item" onclick="showSection('events')">
        <span class="icon">üî•</span> Events
      </div>
      <div class="nav-item" onclick="showSection('fraud')">
        <span class="icon">üõ°Ô∏è</span> Fraud
      </div>
    </nav>
    <div class="sidebar-footer">
      <span class="status-dot"></span>track.apptrack.in<br>
      <span style="margin-top:4px;display:block" id="sidebar-key"></span>
    </div>
  </div>

  <!-- Main -->
  <div class="main">

    <!-- OVERVIEW -->
    <div class="section active" id="section-overview">
      <div class="section-header">
        <div class="section-title">Overview</div>
        <button class="btn btn-outline" onclick="loadOverview()">‚Üª Refresh</button>
      </div>
      <div class="stats-grid">
        <div class="stat-card green">
          <div class="stat-label">Total Clicks</div>
          <div class="stat-value" id="stat-clicks">‚Äî</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">Installs</div>
          <div class="stat-value" id="stat-installs">‚Äî</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-label">Events</div>
          <div class="stat-value" id="stat-events">‚Äî</div>
        </div>
        <div class="stat-card red">
          <div class="stat-label">Fraud Blocked</div>
          <div class="stat-value" id="stat-fraud">‚Äî</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Recent Activity</div>
        <div id="recent-activity" style="padding:20px">
          <div class="loading"></div>
        </div>
      </div>
    </div>

    <!-- CAMPAIGNS -->
    <div class="section" id="section-campaigns">
      <div class="section-header">
        <div class="section-title">Campaigns</div>
        <button class="btn btn-accent" onclick="openCreateCampaign()">+ New Campaign</button>
      </div>
      <div class="card">
        <div id="campaigns-table">
          <div style="padding:20px"><div class="loading"></div></div>
        </div>
      </div>
    </div>

    <!-- LIVE LOGS -->
    <div class="section" id="section-logs">
      <div class="section-header">
        <div class="section-title">Live Logs</div>
        <div style="display:flex;gap:10px">
          <button class="btn btn-outline" onclick="clearLogs()">Clear</button>
          <button class="btn btn-accent" id="log-toggle" onclick="toggleLogs()">‚è∏ Pause</button>
        </div>
      </div>
      <div class="log-container" id="log-container">
        <div class="log-line">
          <span class="log-time">--:--:--</span>
          <span class="log-info">Waiting for events...</span>
        </div>
      </div>
    </div>

    <!-- INSTALLS -->
    <div class="section" id="section-installs">
      <div class="section-header">
        <div class="section-title">Installs</div>
        <button class="btn btn-outline" onclick="loadInstalls()">‚Üª Refresh</button>
      </div>
      <div class="card">
        <div id="installs-table">
          <div style="padding:20px"><div class="loading"></div></div>
        </div>
      </div>
    </div>

    <!-- EVENTS -->
    <div class="section" id="section-events">
      <div class="section-header">
        <div class="section-title">Events</div>
        <button class="btn btn-outline" onclick="loadEvents()">‚Üª Refresh</button>
      </div>
      <div class="card">
        <div id="events-table">
          <div style="padding:20px"><div class="loading"></div></div>
        </div>
      </div>
    </div>

    <!-- FRAUD -->
    <div class="section" id="section-fraud">
      <div class="section-header">
        <div class="section-title">Fraud Reports</div>
        <button class="btn btn-outline" onclick="loadFraud()">‚Üª Refresh</button>
      </div>
      <div class="card">
        <div id="fraud-table">
          <div style="padding:20px"><div class="loading"></div></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- CREATE CAMPAIGN MODAL -->
<div class="modal-overlay" id="campaign-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('campaign-modal')">√ó</button>
    <h3>New Campaign</h3>

    <div class="form-group">
      <label>Campaign Name</label>
      <input type="text" id="c-name" placeholder="Quiz OK CPE Campaign">
    </div>
    <div class="form-group">
      <label>App Bundle ID</label>
      <input type="text" id="c-appid" placeholder="com.your.app">
    </div>
    <div class="form-group">
      <label>Source / Network</label>
      <input type="text" id="c-source" placeholder="pubscale">
    </div>
    <div class="form-group">
      <label>Offer ID</label>
      <input type="text" id="c-offerid" placeholder="12345">
    </div>
    <div class="form-group">
      <label>Play Store URL</label>
      <input type="text" id="c-playstore" placeholder="https://play.google.com/store/apps/details?id=...">
    </div>

    <div style="margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);font-family:var(--font-mono);margin-bottom:12px">Events & Postbacks</div>
      <div id="event-rows"></div>
      <button class="add-event-btn" onclick="addEventRow()">+ Add Event</button>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('campaign-modal')">Cancel</button>
      <button class="btn btn-accent" onclick="createCampaign()">Create Campaign</button>
    </div>
  </div>
</div>

<!-- CAMPAIGN DETAIL MODAL -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <button class="close-modal" onclick="closeModal('detail-modal')">√ó</button>
    <h3 id="detail-name">Campaign Details</h3>
    <div id="detail-content"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const API = 'https://track.apptrack.in';
let apiKey = '';
let logsPaused = false;
let logInterval = null;
let lastLogCount = 0;

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function doLogin() {
  const key = document.getElementById('login-key').value.trim();
  if (!key) return;

  try {
    const res = await fetch(`${API}/v1/health`, {
      headers: { 'X-API-Key': key }
    });
    if (res.ok) {
      apiKey = key;
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('sidebar-key').textContent = key.substring(0, 16) + '...';
      initDashboard();
    } else {
      // Try campaigns endpoint to verify key
      const r2 = await fetch(`${API}/v1/campaigns`, {
        headers: { 'X-API-Key': key }
      });
      if (r2.ok || r2.status === 200) {
        apiKey = key;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('sidebar-key').textContent = key.substring(0, 16) + '...';
        initDashboard();
      } else {
        document.getElementById('login-error').style.display = 'block';
      }
    }
  } catch(e) {
    // If server responds at all, accept the key
    apiKey = key;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    document.getElementById('sidebar-key').textContent = key.substring(0, 16) + '...';
    initDashboard();
  }
}

document.getElementById('login-key').addEventListener('keypress', e => {
  if (e.key === 'Enter') doLogin();
});

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initDashboard() {
  loadOverview();
  loadCampaigns();
  startLiveLogs();
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('section-' + name).classList.add('active');
  event.currentTarget.classList.add('active');

  if (name === 'campaigns') loadCampaigns();
  if (name === 'installs') loadInstalls();
  if (name === 'events') loadEvents();
  if (name === 'fraud') loadFraud();
}

// ‚îÄ‚îÄ API HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(path, method = 'GET', body = null) {
  const opts = {
    method,
    headers: {
      'Content-Type': 'application/json',
      'X-API-Key': apiKey
    }
  };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(API + path, opts);
  return res.json();
}

// ‚îÄ‚îÄ OVERVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadOverview() {
  try {
    const campaigns = await api('/v1/campaigns');
    const stats = await api('/v1/stats').catch(() => null);

    document.getElementById('stat-clicks').textContent = stats?.total_clicks ?? '‚Äî';
    document.getElementById('stat-installs').textContent = stats?.total_installs ?? '‚Äî';
    document.getElementById('stat-events').textContent = stats?.total_events ?? '‚Äî';
    document.getElementById('stat-fraud').textContent = stats?.total_fraud ?? '‚Äî';

    const el = document.getElementById('recent-activity');
    if (campaigns && campaigns.length > 0) {
      el.innerHTML = `
        <table>
          <thead><tr>
            <th>Campaign</th><th>App</th><th>Source</th><th>Status</th><th>Created</th>
          </tr></thead>
          <tbody>
            ${campaigns.slice(0,5).map(c => `
              <tr>
                <td>${c.name}</td>
                <td>${c.app_id}</td>
                <td><span class="badge badge-purple">${c.source}</span></td>
                <td><span class="badge ${c.is_active ? 'badge-green' : 'badge-red'}">${c.is_active ? 'ACTIVE' : 'PAUSED'}</span></td>
                <td>${new Date(c.created_at).toLocaleDateString()}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
    } else {
      el.innerHTML = '<div class="empty-state"><div class="icon">üìä</div>No campaigns yet</div>';
    }
  } catch(e) {
    console.error(e);
  }
}

// ‚îÄ‚îÄ CAMPAIGNS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadCampaigns() {
  try {
    const campaigns = await api('/v1/campaigns');
    const el = document.getElementById('campaigns-table');

    if (!campaigns || campaigns.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="icon">üéØ</div>No campaigns. Create your first one!</div>';
      return;
    }

    el.innerHTML = `
      <table>
        <thead><tr>
          <th>Name</th><th>App ID</th><th>Source</th><th>Events</th><th>Status</th><th>Tracking URL</th><th>Actions</th>
        </tr></thead>
        <tbody>
          ${campaigns.map(c => `
            <tr>
              <td><b>${c.name}</b></td>
              <td>${c.app_id}</td>
              <td><span class="badge badge-purple">${c.source}</span></td>
              <td>${Object.keys(c.events || {}).join(', ') || '‚Äî'}</td>
              <td><span class="badge ${c.is_active ? 'badge-green' : 'badge-red'}">${c.is_active ? 'ACTIVE' : 'PAUSED'}</span></td>
              <td>
                <div class="url-box" onclick="copyUrl('${c.tracking_url}')" title="Click to copy">
                  ${c.tracking_url.substring(0, 50)}...
                </div>
              </td>
              <td>
                <div style="display:flex;gap:6px">
                  <button class="btn btn-outline" onclick="showCampaignDetail(${JSON.stringify(c).replace(/"/g, '&quot;')})">View</button>
                  <button class="btn btn-danger" onclick="deleteCampaign('${c.id}')">Delete</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  } catch(e) {
    document.getElementById('campaigns-table').innerHTML = '<div style="padding:20px;color:var(--red)">Failed to load campaigns</div>';
  }
}

function showCampaignDetail(c) {
  document.getElementById('detail-name').textContent = c.name;
  document.getElementById('detail-content').innerHTML = `
    <div style="margin-bottom:16px">
      <div class="form-group">
        <label>Campaign ID</label>
        <div class="url-box" onclick="copyText('${c.id}')">${c.id}</div>
      </div>
      <div class="form-group">
        <label>Tracking URL</label>
        <div class="url-box" onclick="copyText('${c.tracking_url}')">${c.tracking_url}</div>
      </div>
      <div class="form-group">
        <label>Events</label>
        ${Object.entries(c.events || {}).map(([name, cfg]) => `
          <div style="margin-bottom:8px;padding:10px;background:var(--surface2);border-radius:6px">
            <div style="color:var(--accent);font-weight:700;margin-bottom:4px">${name}</div>
            <div style="font-size:11px;color:var(--muted)">${cfg.postback_url}</div>
          </div>
        `).join('')}
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-accent" onclick="copyText('${c.tracking_url}');showToast('Tracking URL copied!')">Copy Tracking URL</button>
    </div>
  `;
  document.getElementById('detail-modal').classList.add('open');
}

async function deleteCampaign(id) {
  if (!confirm('Delete this campaign?')) return;
  try {
    await api('/v1/campaigns/' + id, 'DELETE');
    showToast('Campaign deleted!');
    loadCampaigns();
  } catch(e) {
    showToast('Delete failed');
  }
}

// ‚îÄ‚îÄ CREATE CAMPAIGN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCreateCampaign() {
  document.getElementById('event-rows').innerHTML = '';
  addEventRow('install', 'https://offers-kraken.affise.com/postback?clickid={clickid}');
  document.getElementById('campaign-modal').classList.add('open');
}

function addEventRow(name = '', url = '') {
  const div = document.createElement('div');
  div.className = 'event-row';
  div.innerHTML = `
    <input type="text" placeholder="event_name" value="${name}" style="padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--font-mono);font-size:12px;outline:none">
    <input type="text" placeholder="https://postback-url?clickid={clickid}" value="${url}" style="padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--font-mono);font-size:12px;outline:none">
    <button onclick="this.parentElement.remove()" style="background:rgba(255,68,68,0.1);border:none;color:var(--red);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px">√ó</button>
  `;
  document.getElementById('event-rows').appendChild(div);
}

async function createCampaign() {
  const name     = document.getElementById('c-name').value.trim();
  const appId    = document.getElementById('c-appid').value.trim();
  const source   = document.getElementById('c-source').value.trim();
  const offerId  = document.getElementById('c-offerid').value.trim();
  const playStore = document.getElementById('c-playstore').value.trim();

  if (!name || !appId || !source) {
    showToast('Fill required fields!'); return;
  }

  const events = {};
  document.querySelectorAll('#event-rows .event-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const eName = inputs[0].value.trim();
    const eUrl  = inputs[1].value.trim();
    if (eName && eUrl) events[eName] = { postback_url: eUrl };
  });

  try {
    const res = await api('/v1/campaigns', 'POST', {
      name, app_id: appId, source, offer_id: offerId,
      play_store_url: playStore, events
    });

    closeModal('campaign-modal');
    showToast('‚úÖ Campaign created!');
    loadCampaigns();
  } catch(e) {
    showToast('Failed to create campaign');
  }
}

// ‚îÄ‚îÄ LIVE LOGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startLiveLogs() {
  if (logInterval) clearInterval(logInterval);
  logInterval = setInterval(fetchLogs, 3000);
}

async function fetchLogs() {
  if (logsPaused) return;
  try {
    const logs = await api('/v1/logs').catch(() => null);
    if (!logs || !logs.logs) return;

    const container = document.getElementById('log-container');
    const newLogs = logs.logs.slice(lastLogCount);
    lastLogCount = logs.logs.length;

    newLogs.forEach(log => {
      const div = document.createElement('div');
      div.className = 'log-line';
      const time = new Date().toTimeString().substring(0, 8);
      let cls = 'log-info';
      if (log.includes('[INSTALL]')) cls = 'log-install';
      else if (log.includes('[EVENT]')) cls = 'log-event';
      else if (log.includes('[FRAUD]')) cls = 'log-fraud';
      else if (log.includes('[POSTBACK]')) cls = 'log-postback';
      else if (log.includes('[CLICK]')) cls = 'log-click';

      div.innerHTML = `<span class="log-time">${time}</span><span class="${cls}">${log}</span>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;
    });
  } catch(e) {}
}

function toggleLogs() {
  logsPaused = !logsPaused;
  document.getElementById('log-toggle').textContent = logsPaused ? '‚ñ∂ Resume' : '‚è∏ Pause';
}

function clearLogs() {
  document.getElementById('log-container').innerHTML = '<div class="log-line"><span class="log-time">--:--:--</span><span class="log-info">Logs cleared</span></div>';
  lastLogCount = 0;
}

// ‚îÄ‚îÄ INSTALLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadInstalls() {
  try {
    const data = await api('/v1/installs').catch(() => ({ installs: [] }));
    const el = document.getElementById('installs-table');
    const installs = data.installs || [];

    if (installs.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="icon">üì≤</div>No installs tracked yet</div>';
      return;
    }

    el.innerHTML = `
      <table>
        <thead><tr>
          <th>UID</th><th>Model</th><th>Click ID</th><th>IP</th><th>Debug</th><th>IVC</th><th>Time</th>
        </tr></thead>
        <tbody>
          ${installs.map(i => `
            <tr>
              <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">${i.uid}</td>
              <td>${i.model || '‚Äî'}</td>
              <td>${i.clickid ? `<span class="badge badge-green">${i.clickid}</span>` : '<span class="badge badge-yellow">organic</span>'}</td>
              <td>${i.ip || '‚Äî'}</td>
              <td>${i.is_debug ? '<span class="badge badge-yellow">DEBUG</span>' : '<span class="badge badge-green">PROD</span>'}</td>
              <td>${i.ivc ? '<span class="badge badge-green">‚úì</span>' : '<span class="badge badge-red">‚úó</span>'}</td>
              <td>${i.time ? new Date(i.time).toLocaleString() : '‚Äî'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  } catch(e) {
    document.getElementById('installs-table').innerHTML = '<div style="padding:20px;color:var(--muted)">No data available yet</div>';
  }
}

// ‚îÄ‚îÄ EVENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadEvents() {
  try {
    const data = await api('/v1/events/log').catch(() => ({ events: [] }));
    const el = document.getElementById('events-table');
    const events = data.events || [];

    if (events.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="icon">üî•</div>No events tracked yet</div>';
      return;
    }

    el.innerHTML = `
      <table>
        <thead><tr>
          <th>Event</th><th>UID</th><th>Click ID</th><th>Postback</th><th>Time</th>
        </tr></thead>
        <tbody>
          ${events.map(e => `
            <tr>
              <td><span class="badge badge-purple">${e.event_name}</span></td>
              <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">${e.uid}</td>
              <td>${e.clickid || '<span style="color:var(--muted)">organic</span>'}</td>
              <td>${e.postback_fired ? '<span class="badge badge-green">FIRED</span>' : '<span class="badge badge-yellow">SKIPPED</span>'}</td>
              <td>${e.time ? new Date(e.time).toLocaleString() : '‚Äî'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  } catch(e) {
    document.getElementById('events-table').innerHTML = '<div style="padding:20px;color:var(--muted)">No data available yet</div>';
  }
}

// ‚îÄ‚îÄ FRAUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadFraud() {
  try {
    const data = await api('/v1/fraud').catch(() => ({ blocked: [] }));
    const el = document.getElementById('fraud-table');
    const blocked = data.blocked || [];

    if (blocked.length === 0) {
      el.innerHTML = '<div class="empty-state"><div class="icon">üõ°Ô∏è</div>No fraud detected</div>';
      return;
    }

    el.innerHTML = `
      <table>
        <thead><tr>
          <th>Device ID</th><th>Reason</th><th>UID</th><th>Time</th>
        </tr></thead>
        <tbody>
          ${blocked.map(f => `
            <tr>
              <td>${f.device_id}</td>
              <td><span class="badge badge-red">${f.reason}</span></td>
              <td>${f.uid || '‚Äî'}</td>
              <td>${f.time ? new Date(f.time).toLocaleString() : '‚Äî'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  } catch(e) {
    document.getElementById('fraud-table').innerHTML = '<div style="padding:20px;color:var(--muted)">No data available yet</div>';
  }
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function copyUrl(url) {
  navigator.clipboard.writeText(url);
  showToast('‚úÖ Tracking URL copied!');
}

function copyText(text) {
  navigator.clipboard.writeText(text);
  showToast('‚úÖ Copied!');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => {
    if (e.target === m) m.classList.remove('open');
  });
});
</script>
</body>
</html>
